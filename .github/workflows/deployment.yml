name: Deployment

on:
  # Deploy saat ada commit yang di-push di branch master.
  push:
    branches:
      - master
  # Deploy secara manual dari GitHub.
  workflow_dispatch:

concurrency:
  group: "heroku"
  cancel-in-progress: true

jobs:
  deploy:
    name: Deployment
    runs-on: ubuntu-latest
    steps:
    - name: Check secrets
      run: |
        if [ "${{ secrets.HEROKU_API_KEY }}" == "" ] || [ "${{ secrets.RAILWAY_TOKEN }}" == "" ] ; then
          exit 1
        fi
    - name: Use Node 12
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Install Railway
      run: npm i -g @railway/cli
    - name: Deploy to Railway
      run: railway up
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    - name: Create GitHub deployment
      uses: chrnorm/deployment-action@v2
      with:
        initial-status: success
        token: ${{ github.token }}
        # Assuming you are not using custom domain on Heroku, the target_url
        # will contain the URL to your application hosted under Heroku's
        # subdomain.
        environment-url: https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com
        environment: production
